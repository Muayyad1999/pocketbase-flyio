name: Test Pull Request

on:
  pull_request:
    branches:
      - master
    paths:
      - 'Dockerfile'
      - 'scripts/**'
      - 'fly.toml'
      - '.github/workflows/**'

jobs:
  test-build:
    name: Test Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: pocketbase:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run --rm pocketbase:test pocketbase --version

      - name: Validate fly.toml
        run: |
          if [ -f fly.toml ]; then
            echo "‚úÖ fly.toml exists"
            # Basic validation
            grep -q "app = " fly.toml && echo "‚úÖ App name configured"
            grep -q "internal_port = 8090" fly.toml && echo "‚úÖ Port configured"
            grep -q "destination = \"/pocketbase/data\"" fly.toml && echo "‚úÖ Volume mount configured"
          else
            echo "‚ùå fly.toml not found"
            exit 1
          fi

      - name: Check scripts
        run: |
          echo "Checking entrypoint script..."
          if [ -f scripts/entrypoint.sh ]; then
            echo "‚úÖ entrypoint.sh exists"
            # Check if executable
            if [ -x scripts/entrypoint.sh ]; then
              echo "‚úÖ entrypoint.sh is executable"
            else
              echo "‚ö†Ô∏è  entrypoint.sh not executable (will be fixed in Dockerfile)"
            fi
          else
            echo "‚ùå entrypoint.sh not found"
            exit 1
          fi

  shellcheck:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning

  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [test-build, shellcheck]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.test-build.result }}" == "success" ] && [ "${{ needs.shellcheck.result }}" == "success" ]; then
            echo "‚úÖ All checks passed! Ready to merge."
          else
            echo "‚ùå Some checks failed. Please review."
            exit 1
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
            ## üß™ Test Results

            - ${{ needs.test-build.result == 'success' && '‚úÖ' || '‚ùå' }} Docker Build
            - ${{ needs.shellcheck.result == 'success' && '‚úÖ' || '‚ùå' }} Shell Script Linting

            ${{ needs.test-build.result == 'success' && needs.shellcheck.result == 'success' && '**Status:** All checks passed! ‚ú®' || '**Status:** Some checks failed. Please review the logs.' }}

            ---
            ü§ñ Automated test report
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
